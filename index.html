<script>
/* ================= CONFIG EMPRESA ================= */
const EMPRESA_ID = "presupuesto5_25";

/* ================= PRODUCTOS ================= */
const productosBase = [
 { nombre: "Pan de pancho", precio: 920 },
 { nombre: "Pan de hamburguesa", precio: 920 },
 { nombre: "Prepizza", precio: 1120 },
 { nombre: "Roscas glaciadas", precio: 10700 },
 { nombre: "Sandwich de miga grande", precio: 2000 }
];

const PRECIOS_KEY = `precios_${EMPRESA_ID}`;

function resetear(){
    if(confirm("¿Seguro que desea restablecer precios?")){
        localStorage.removeItem(PRECIOS_KEY);
        location.reload();
    }
}

let productos = JSON.parse(localStorage.getItem(PRECIOS_KEY)) || productosBase;
let pedido = {};

/* ================= ADMIN ================= */
const config = document.getElementById("config");
productos.forEach((p,i)=>{
    config.innerHTML += `
        <div class="item">
            <span>${p.nombre}</span>
            <input type="number" id="precio_${i}" value="${p.precio}">
        </div>`;
});

function guardarPrecios(){
    productos.forEach((p,i)=>{
        p.precio = +document.getElementById(`precio_${i}`).value || 0;
    });
    localStorage.setItem(PRECIOS_KEY,JSON.stringify(productos));
    alert("Precios guardados");
}

/* ================= CATALOGO ================= */
const catalogo = document.getElementById("catalogo");

function renderCatalogo(f=""){
    catalogo.innerHTML="";
    productos.forEach((p,i)=>{
        if(p.nombre.toLowerCase().includes(f.toLowerCase())){
            catalogo.innerHTML+=`
                <div class="item">
                    <span>${p.nombre}</span>
                    <input type="number" min="1" placeholder="Cant"
                        onchange="agregar(${i},this.value)">
                </div>`;
        }
    });
}
renderCatalogo();

document.getElementById("busqueda")
.addEventListener("input",e=>renderCatalogo(e.target.value));

/* ================= PEDIDO ================= */
function agregar(i,cant){
    cant=parseInt(cant);
    if(!cant || cant<=0) return;

    if(pedido[i]) pedido[i].cantidad+=cant;
    else pedido[i]={...productos[i],cantidad:cant};

    renderPreview();
}

function quitar(i){
    delete pedido[i];
    renderPreview();
}

function renderPreview(){
    let html=`
        <tr>
            <th>Producto</th><th>Cant</th><th>Total</th><th></th>
        </tr>`;
    let sub=0;

    Object.keys(pedido).forEach(i=>{
        const p=pedido[i];
        const t=p.cantidad*p.precio;
        sub+=t;

        html+=`
        <tr>
            <td>${p.nombre}</td>
            <td>${p.cantidad}</td>
            <td>$${t}</td>
            <td><button onclick="quitar(${i})">❌</button></td>
        </tr>`;
    });

    document.getElementById("preview").innerHTML=html;
    document.getElementById("subtotal").innerText=
        "SUBTOTAL: $"+sub.toLocaleString("es-AR");
}

/* ================= CLIENTES (LOCAL DB) ================= */
const CLIENTES_KEY = `clientes_${EMPRESA_ID}`;
let clientes = JSON.parse(localStorage.getItem(CLIENTES_KEY)) || {};

const nombreInput = document.getElementById("clienteNombre");
const direccionInput = document.getElementById("clienteDireccion");
const descripcionInput = document.getElementById("clienteDescripcion");
const listaClientes = document.getElementById("listaClientes");

nombreInput.addEventListener("input",()=>{
    const texto = nombreInput.value.toLowerCase().trim();
    listaClientes.innerHTML = "";

    if(!texto){
        listaClientes.style.display = "none";
        return;
    }

    const coincidencias = Object.keys(clientes)
        .filter(n => n.toLowerCase().includes(texto));

    if(coincidencias.length === 0){
        listaClientes.style.display = "none";
        return;
    }

    coincidencias.forEach(nombre=>{
        const div = document.createElement("div");
        div.innerText = nombre;

        div.onclick = ()=>{
            nombreInput.value = nombre;
            direccionInput.value = clientes[nombre].direccion || "";
            descripcionInput.value = clientes[nombre].descripcion || "";
            listaClientes.style.display = "none";
        };

        listaClientes.appendChild(div);
    });

    listaClientes.style.display = "block";
});

/* ================= FINAL ================= */
let textoWhatsApp = "";

function calcular(){
    let total = 0;
    textoWhatsApp = "Presupuesto\n\n";

    const nombre = nombreInput.value.trim();
    const direccion = direccionInput.value.trim();
    const descripcion = descripcionInput.value.trim();

    if(nombre){
        clientes[nombre] = { direccion, descripcion };
        localStorage.setItem(CLIENTES_KEY, JSON.stringify(clientes));

        textoWhatsApp += `Cliente: ${nombre}\n`;
        if(direccion) textoWhatsApp += `Dirección: ${direccion}\n`;
        if(descripcion) textoWhatsApp += `${descripcion}\n`;
        textoWhatsApp += "\n";
    }

    let html = `
        <tr>
            <th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th>
        </tr>`;

    Object.values(pedido).forEach(p=>{
        const t = p.cantidad * p.precio;
        total += t;

        html += `
        <tr>
            <td>${p.nombre}</td>
            <td>${p.cantidad}</td>
            <td>$${p.precio}</td>
            <td>$${t}</td>
        </tr>`;

        textoWhatsApp += `* ${p.nombre} - ${p.cantidad} un - $${t.toLocaleString("es-AR")}\n`;
    });

    textoWhatsApp += `\nTOTAL: $${total.toLocaleString("es-AR")}`;

    document.getElementById("tabla").innerHTML = html;
    document.getElementById("total").innerText =
        "TOTAL: $" + total.toLocaleString("es-AR");
}

function enviarWhatsApp(){
    if(!textoWhatsApp) return alert("Calcule el total primero");
    window.open("https://wa.me/?text="+encodeURIComponent(textoWhatsApp));
}

function imprimir(){ window.print(); }
</script>
